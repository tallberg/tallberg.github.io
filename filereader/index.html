<!DOCTYPE html>
<html lang="en" ondrop="dropHandler(event)" ondragover="dragOverHandler(event)">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JSON-Reader</title>
<style>
body {
    color:#333;
    font-family: 'Courier New', Courier, monospace;
    padding: 25px;
}
button {
  background-color: #8ecf6f;
  border: none;
  color: #333;
  cursor: pointer;
  padding: 15px 32px;
  text-align: center;
  font-size: 16px;
  box-shadow: 2px 2px 2px #aaa, -2px -2px 2px #fff,;
  font-family: 'Courier New', Courier, monospace;
}
button:disabled {
  background-color: #526b46;
  cursor: not-allowed;
}

</style>
</head>

<!--Entire page is dropzone "#input" is just cosmetics-->
<body>
<h1>Drag and drop file anywhere</h1>
<p>File will be parsed as json if possible, else row by row into an array.<br> Resulting object will be accessible from dev console (Press F12).</p>
<button type="button" id="save" disabled="disabled" onclick="save()">Save "data" as data.json</button>
</body>

<script>
const input = document.getElementById('input');
var data;

function dragOverHandler(ev) {
  ev.preventDefault();
}

async function dropHandler(ev) {
  ev.preventDefault();
  fileItemHandle = await ev.dataTransfer.items[0].getAsFileSystemHandle();
  const file = await fileItemHandle.getFile();
  const fr = new FileReader();
  fr.addEventListener('load', () => { parse(fr.result) });
  fr.readAsText(file,'ISO-8859-1'); //Latin-1
}

function parse(text) {
  try {
    data = JSON.parse(text);
  } catch {
    console.log("Failed to load data as JSON");

    if (text.indexOf('\n')!=-1) {
      console.log('Saving rows to array');
      data = text.split(/\r?\n/);
    } else {
      console.log('Saving entire text')
      data = text;
    }
  }
  console.log('File is loaded into variable: "data"');
  if (Array.isArray(data)) {
    const length = data.length;
    const size = new Blob([JSON.stringify(data)]).size;
    const type = typeof(data[0]);
    console.log(`data is an array of ${length} ${type}s with an average size of ${Math.round(size/length)} bytes.`);    
    if (data[0] != null && typeof(data[0]) == "object") {
      console.log("first object keys:", Object.keys(data[0]).sort())
    }
  } else if (data != null && typeof(data) == "object") {
    console.log("data is an object with keys:", Object.keys(data).sort())
  } else {
    console.log(`data is of type ${typeof(data)}`);
  }

  document.getElementById('save').disabled = false;
}

function save() {
  const output = JSON.stringify(data);
  const a = document.createElement('a');
  a.href = 'data:application/json,' + encodeURI(output);
  a.target = '_blank';
  a.download = 'data.json';
  a.click();
}

</script>
</html>
